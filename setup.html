<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Setup - Configuration</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .progress-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            gap: 20px;
        }
        
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .step-indicator.active {
            background: #667eea;
            color: white;
        }
        
        .step-indicator.completed {
            background: #28a745;
            color: white;
        }
        
        .step-connector {
            width: 60px;
            height: 2px;
            background: #e9ecef;
            transition: all 0.3s ease;
        }
        
        .step-connector.completed {
            background: #28a745;
        }
        
        .setup-section {
            margin: 30px 0;
            padding: 25px;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .setup-section.completed {
            border-color: #28a745;
            background: #f8fff8;
        }
        
        .setup-section.active {
            border-color: #667eea;
            background: #f8f9ff;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .section-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .section-status.configured {
            background: #d4edda;
            color: #155724;
        }
        
        .section-status.missing {
            background: #f8d7da;
            color: #721c24;
        }
        
        .form-group {
            margin: 20px 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="text"], input[type="password"], input[type="url"], select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .help-text {
            font-size: 14px;
            color: #6c757d;
            margin-top: 8px;
            line-height: 1.5;
        }
        
        .help-text a {
            color: #667eea;
            text-decoration: none;
        }
        
        .help-text a:hover {
            text-decoration: underline;
        }
        
        .button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px 4px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .button.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .button.secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }
        
        .button.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        
        .button-group {
            text-align: center;
            margin: 25px 0;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .status-message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .status-message.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .dashboard-action {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-top: 40px;
        }
        
        .dashboard-action h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .dashboard-action p {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
        }
        
        #caldav-fields {
            display: none;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; height: 0; }
            to { opacity: 1; height: auto; }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .progress-indicator {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .step-connector {
                width: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Dashboard Setup</h1>
        <p class="subtitle">Configure your dashboard in 3 easy steps</p>
        
        <div class="progress-indicator">
            <div class="step-indicator" id="step1">1</div>
            <div class="step-connector" id="connector1"></div>
            <div class="step-indicator" id="step2">2</div>
            <div class="step-connector" id="connector2"></div>
            <div class="step-indicator" id="step3">3</div>
        </div>
        
        <!-- Step 1: Weather API -->
        <div class="setup-section" id="weather-section">
            <div class="section-header">
                <div class="section-title">
                    <span>üå§Ô∏è</span>
                    <span>Weather API</span>
                </div>
                <div class="section-status missing" id="weather-status">Required</div>
            </div>
            
            <div class="form-group">
                <label for="weather-key">OpenWeatherMap API Key:</label>
                <input type="password" id="weather-key" placeholder="Enter your API key">
                <div class="help-text">
                    Get your free API key from <a href="https://openweathermap.org/api" target="_blank">OpenWeatherMap</a>.
                    Sign up, verify your email, and copy the key from your dashboard.
                </div>
            </div>
            
            <div class="button-group">
                <button class="button" onclick="testWeatherAPI()">
                    <span>üîç</span> Test API
                </button>
                <button class="button" onclick="debugWeatherAPI()" style="background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);">
                    <span>üêõ</span> Debug Weather Data
                </button>
                <button class="button success" onclick="saveWeatherConfig()">
                    <span>üíæ</span> Save & Continue
                </button>
            </div>
        </div>
        
        <!-- Step 2: Calendar Setup -->
        <div class="setup-section" id="calendar-section">
            <div class="section-header">
                <div class="section-title">
                    <span>üìÖ</span>
                    <span>Calendar (CalDAV)</span>
                </div>
                <div class="section-status missing" id="calendar-status">Optional</div>
            </div>
            
            <!-- Current Configuration Display -->
            <div id="current-caldav-config" style="display: none;">
                <div style="background: #e3f2fd; border: 2px solid #2196f3; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #1565c0; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        <span>üìã</span> Current Configuration
                    </h4>
                    <div id="current-config-details" style="margin-bottom: 15px;"></div>
                    <div class="button-group">
                        <button class="button" onclick="testCurrentConnection()">
                            <span>üîç</span> Test Current Connection
                        </button>
                        <button class="button" onclick="debugConnection()">
                            <span>üêõ</span> Debug Connection
                        </button>
                        <button class="button secondary" onclick="editCurrentConfig()">
                            <span>‚úèÔ∏è</span> Edit Configuration
                        </button>
                        <button class="button danger" onclick="clearCurrentConfig()">
                            <span>üóëÔ∏è</span> Remove Configuration
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="caldav-provider">Calendar Provider:</label>
                <select id="caldav-provider" onchange="toggleCalDAVFields()">
                    <option value="">Select your provider (optional)</option>
                    <option value="google">Google Calendar / Workspace</option>
                    <option value="apple">Apple iCloud Calendar</option>
                    <option value="outlook">Microsoft Outlook</option>
                    <option value="generic">Other CalDAV Server</option>
                </select>
            </div>
            
            <div id="caldav-fields">
                <div class="form-group">
                    <label for="caldav-username">Email/Username:</label>
                    <input type="text" id="caldav-username" placeholder="your.email@gmail.com">
                </div>
                
                <div class="form-group">
                    <label for="caldav-password">Password:</label>
                    <input type="password" id="caldav-password" placeholder="App Password or Account Password">
                    <div id="password-help" class="help-text"></div>
                </div>
                
                <div class="form-group" id="custom-endpoint-group" style="display: none;">
                    <label for="caldav-endpoint">CalDAV Server URL:</label>
                    <input type="url" id="caldav-endpoint" placeholder="https://caldav.example.com/dav/">
                </div>
                
                <div class="button-group">
                    <button class="button" onclick="testCalDAVConnection()">
                        <span>üîç</span> Test Connection
                    </button>
                    <button class="button success" onclick="saveCalDAVConfig()">
                        <span>üíæ</span> Save Calendar
                    </button>
                    <button class="button danger" onclick="clearCalDAVConfig()">
                        <span>üóëÔ∏è</span> Clear
                    </button>
                </div>
            </div>
            
            <div class="button-group" id="skip-calendar" style="display: block;">
                <button class="button secondary" onclick="skipCalendar()">
                    <span>‚è≠Ô∏è</span> Skip Calendar Setup
                </button>
            </div>
        </div>
        
        <!-- Step 3: Location -->
        <div class="setup-section" id="location-section">
            <div class="section-header">
                <div class="section-title">
                    <span>üìç</span>
                    <span>Location</span>
                </div>
                <div class="section-status configured" id="location-status">Loading...</div>
            </div>
            
            <div class="button-group">
                <button class="button" onclick="detectLocation()" id="detect-location-btn">
                    <span>üìç</span> Auto-Detect Location
                </button>
            </div>
            
            <div class="form-group">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px;">
                    <div>
                        <label for="location-city">City:</label>
                        <input type="text" id="location-city" placeholder="New York">
                    </div>
                    <div>
                        <label for="location-state">State:</label>
                        <input type="text" id="location-state" placeholder="NY" maxlength="2" style="text-transform: uppercase;">
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="button success" onclick="saveLocationConfig()">
                    <span>üìç</span> Save Location
                </button>
            </div>
        </div>
        
        <div id="status" class="status-message"></div>
        
        <!-- Debug Information Display -->
        <div id="debug-section" style="display: none; margin-top: 30px;">
            <div class="setup-section">
                <div class="section-header">
                    <div class="section-title">
                        <span>üêõ</span>
                        <span>Debug Information</span>
                    </div>
                    <button class="button secondary" onclick="hideDebugInfo()" style="padding: 8px 16px; font-size: 14px;">
                        <span>‚ùå</span> Close
                    </button>
                </div>
                <div id="debug-content" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.4; max-height: 400px; overflow-y: auto; white-space: pre-wrap;"></div>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="button" onclick="copyDebugInfo()">
                        <span>üìã</span> Copy to Clipboard
                    </button>
                    <button class="button" onclick="exportDebugInfo()">
                        <span>üíæ</span> Export Debug Log
                    </button>
                </div>
            </div>
        </div>
        
        <div class="dashboard-action" id="dashboard-action" style="display: none;">
            <h3>üéâ Setup Complete!</h3>
            <p>Your dashboard is ready to use. Click below to view your personalized dashboard.</p>
            <button class="button" onclick="goToDashboard()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); font-size: 18px; padding: 15px 30px;">
                <span>üöÄ</span> Launch Dashboard
            </button>
        </div>
    </div>
    
    <script src="config.js"></script>
    <script src="api-client.js"></script>
    <script src="caldav-client.js"></script>
    <script>
        let caldavClient = null;
        let completedSteps = {
            weather: false,
            calendar: false,
            location: false
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSetup();
        });
        
        function initializeSetup() {
            const config = window.dashboardConfig;
            
            // Load existing configuration
            loadExistingConfig();
            updateProgressIndicator();
            updateSectionStates();
            
            // Auto-detect location for new users
            if (!config.get('location.city') || config.get('location.city') === 'New York') {
                setTimeout(detectLocation, 1000);
            }
        }
        
        function loadExistingConfig() {
            const config = window.dashboardConfig;
            
            // Load weather API key
            const weatherKey = config.get('openweather_api_key');
            if (weatherKey) {
                document.getElementById('weather-key').value = weatherKey;
                completedSteps.weather = true;
            }
            
            // Load location
            const city = config.get('location.city') || 'New York';
            const state = config.get('location.state') || 'NY';
            document.getElementById('location-city').value = city;
            document.getElementById('location-state').value = state;
            
            // Update the location status display
            document.getElementById('location-status').textContent = `${city}, ${state}`;
            
            completedSteps.location = true;
            
            // Load CalDAV config if exists
            loadCalDAVConfig();
        }
        
        function loadCalDAVConfig() {
            try {
                if (!caldavClient) {
                    caldavClient = new CalDAVClient(window.dashboardConfig);
                }
                
                const status = caldavClient.getConfigStatus();
                if (status.configured) {
                    completedSteps.calendar = true;
                    updateCalendarStatus('‚úÖ ' + status.message, 'configured');
                    showCurrentConfig(status);
                } else {
                    hideCurrentConfig();
                }
            } catch (error) {
                console.warn('Could not load CalDAV config:', error);
                hideCurrentConfig();
            }
        }
        
        function showCurrentConfig(status) {
            try {
                // Load from CalDAV client's localStorage
                const saved = localStorage.getItem('dashboard-caldav-config');
                if (!saved) {
                    hideCurrentConfig();
                    return;
                }
                
                const config = JSON.parse(saved);
                const provider = config.provider;
                const username = config.username;
                const endpoint = config.customEndpoint;
                const savedAt = config.savedAt;
                
                let providerName = '';
                switch(provider) {
                    case 'google': providerName = 'Google Calendar'; break;
                    case 'apple': providerName = 'Apple iCloud'; break;
                    case 'outlook': providerName = 'Microsoft Outlook'; break;
                    case 'generic': providerName = 'Custom CalDAV Server'; break;
                    default: providerName = 'Unknown Provider';
                }
                
                const configDate = savedAt ? new Date(savedAt).toLocaleString() : 'Unknown';
                
                const configDetails = document.getElementById('current-config-details');
                configDetails.innerHTML = `
                    <div style="display: grid; gap: 10px;">
                        <div><strong>Provider:</strong> ${providerName}</div>
                        <div><strong>Username:</strong> ${username || 'Not set'}</div>
                        ${endpoint ? `<div><strong>Endpoint:</strong> ${endpoint}</div>` : ''}
                        <div><strong>Status:</strong> ${status.message}</div>
                        <div style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                            Last configured: ${configDate}
                        </div>
                    </div>
                `;
                
                document.getElementById('current-caldav-config').style.display = 'block';
                document.getElementById('skip-calendar').style.display = 'none';
            } catch (error) {
                console.warn('Error loading current config for display:', error);
                hideCurrentConfig();
            }
        }
        
        function hideCurrentConfig() {
            document.getElementById('current-caldav-config').style.display = 'none';
        }
        
        function updateProgressIndicator() {
            const steps = ['weather', 'calendar', 'location'];
            
            steps.forEach((step, index) => {
                const stepEl = document.getElementById(`step${index + 1}`);
                if (completedSteps[step]) {
                    stepEl.classList.add('completed');
                    stepEl.classList.remove('active');
                    stepEl.innerHTML = '‚úì';
                } else if (isCurrentStep(step)) {
                    stepEl.classList.add('active');
                    stepEl.classList.remove('completed');
                    stepEl.innerHTML = index + 1;
                } else {
                    stepEl.classList.remove('active', 'completed');
                    stepEl.innerHTML = index + 1;
                }
                
                // Update connectors
                if (index < steps.length - 1) {
                    const connector = document.getElementById(`connector${index + 1}`);
                    if (completedSteps[step]) {
                        connector.classList.add('completed');
                    } else {
                        connector.classList.remove('completed');
                    }
                }
            });
        }
        
        function isCurrentStep(step) {
            if (!completedSteps.weather && step === 'weather') return true;
            if (completedSteps.weather && !completedSteps.calendar && step === 'calendar') return true;
            if (completedSteps.weather && step === 'location') return true;
            return false;
        }
        
        function updateSectionStates() {
            // Weather section
            const weatherSection = document.getElementById('weather-section');
            if (completedSteps.weather) {
                weatherSection.classList.add('completed');
                updateWeatherStatus('‚úÖ Configured', 'configured');
            } else if (isCurrentStep('weather')) {
                weatherSection.classList.add('active');
            }
            
            // Calendar section
            const calendarSection = document.getElementById('calendar-section');
            if (completedSteps.calendar) {
                calendarSection.classList.add('completed');
            } else if (isCurrentStep('calendar')) {
                calendarSection.classList.add('active');
            }
            
            // Location section
            const locationSection = document.getElementById('location-section');
            if (completedSteps.location) {
                locationSection.classList.add('completed');
            } else if (isCurrentStep('location')) {
                locationSection.classList.add('active');
            }
            
            // Show dashboard action if weather is configured
            if (completedSteps.weather) {
                document.getElementById('dashboard-action').style.display = 'block';
            }
        }
        
        // Weather API Functions
        async function testWeatherAPI() {
            const apiKey = document.getElementById('weather-key').value.trim();
            if (!apiKey) {
                showStatus('Please enter your OpenWeatherMap API key first.', 'error');
                return;
            }
            
            const testBtn = document.querySelector('button[onclick="testWeatherAPI()"]');
            const originalHTML = testBtn.innerHTML;
            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Testing...</div>';
            
            try {
                showStatus('Testing weather API...', 'info');
                
                // Test with a simple location
                const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=New York,NY,US&appid=${apiKey}&units=imperial`);
                
                if (response.ok) {
                    const data = await response.json();
                    showStatus(`‚úÖ API test successful! Current weather in NYC: ${Math.round(data.main.temp)}¬∞F, ${data.weather[0].description}`, 'success');
                } else {
                    const error = await response.json();
                    showStatus(`‚ùå API test failed: ${error.message}`, 'error');
                }
            } catch (error) {
                showStatus(`‚ùå API test failed: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = originalHTML;
            }
        }
        
        async function saveWeatherConfig() {
            const apiKey = document.getElementById('weather-key').value.trim();
            if (!apiKey) {
                showStatus('Please enter your OpenWeatherMap API key.', 'error');
                return;
            }
            
            const saveBtn = document.querySelector('button[onclick="saveWeatherConfig()"]');
            const originalHTML = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Saving...</div>';
            
            try {
                const config = window.dashboardConfig;
                config.set('openweather_api_key', apiKey);
                
                completedSteps.weather = true;
                updateProgressIndicator();
                updateSectionStates();
                
                showStatus('‚úÖ Weather API configured successfully!', 'success');
                updateWeatherStatus('‚úÖ Configured', 'configured');
                
            } catch (error) {
                showStatus(`‚ùå Failed to save configuration: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalHTML;
            }
        }
        
        async function debugWeatherAPI() {
            const apiKey = document.getElementById('weather-key').value.trim();
            if (!apiKey) {
                showStatus('Please enter your OpenWeatherMap API key first.', 'error');
                return;
            }
            
            const debugBtn = document.querySelector('button[onclick="debugWeatherAPI()"]');
            const originalHTML = debugBtn.innerHTML;
            debugBtn.disabled = true;
            debugBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Debugging...</div>';
            
            try {
                showStatus('Gathering weather debug information...', 'info');
                
                // Get current location for weather testing
                const city = document.getElementById('location-city').value || 'New York';
                const state = document.getElementById('location-state').value || 'NY';
                
                // Create concise weather debug info
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    tests: []
                };
                
                // Test 1: Current weather API
                try {
                    const currentWeatherUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city},${state},US&appid=${apiKey}&units=imperial`;
                    console.log('Testing current weather API:', currentWeatherUrl.replace(apiKey, '[API_KEY]'));
                    
                    const currentResponse = await fetch(currentWeatherUrl);
                    const currentData = await currentResponse.json();
                    
                    debugInfo.tests.push({
                        test: 'Current Weather API',
                        status: currentResponse.status,
                        success: currentResponse.ok,
                        summary: currentResponse.ok ? {
                            location: `${currentData.name}, ${currentData.sys?.country}`,
                            temperature: `${currentData.main?.temp}¬∞F`,
                            condition: currentData.weather?.[0]?.description,
                            humidity: `${currentData.main?.humidity}%`,
                            wind_speed: `${currentData.wind?.speed} mph`,
                            coordinates: `${currentData.coord?.lat}, ${currentData.coord?.lon}`
                        } : null,
                        error: currentResponse.ok ? null : currentData.message || 'Unknown error'
                    });
                } catch (error) {
                    debugInfo.tests.push({
                        test: 'Current Weather API',
                        success: false,
                        error: error.message
                    });
                }
                
                // Test 2: 5-day forecast API (used by dashboard)
                try {
                    const forecastUrl = `https://api.openweathermap.org/data/2.5/forecast?q=${city},${state},US&appid=${apiKey}&units=imperial`;
                    console.log('Testing forecast API:', forecastUrl.replace(apiKey, '[API_KEY]'));
                    
                    const forecastResponse = await fetch(forecastUrl);
                    const forecastData = await forecastResponse.json();
                    
                    debugInfo.tests.push({
                        test: '5-Day Forecast API',
                        status: forecastResponse.status,
                        success: forecastResponse.ok,
                        summary: forecastResponse.ok ? {
                            location: `${forecastData.city?.name}, ${forecastData.city?.country}`,
                            total_forecasts: forecastData.cnt,
                            next_24h_forecasts: forecastData.list?.slice(0, 8).map(item => ({
                                time: new Date(item.dt * 1000).toLocaleString(),
                                temp: `${item.main.temp}¬∞F`,
                                condition: item.weather[0].description,
                                precipitation: item.rain ? `${item.rain['3h'] || 0}mm` : 'None'
                            })) || [],
                            timezone_offset: `${forecastData.city?.timezone / 3600}h from UTC`
                        } : null,
                        error: forecastResponse.ok ? null : forecastData.message || 'Unknown error'
                    });
                } catch (error) {
                    debugInfo.tests.push({
                        test: '5-Day Forecast API',
                        success: false,
                        error: error.message
                    });
                }
                
                // Add summary info
                debugInfo.summary = {
                    total_tests: debugInfo.tests.length,
                    successful_tests: debugInfo.tests.filter(t => t.success).length,
                    failed_tests: debugInfo.tests.filter(t => !t.success).length,
                    api_key_status: apiKey.length === 32 ? 'Valid length (32 chars)' : `Invalid length (${apiKey.length} chars, should be 32)`,
                    location_tested: `${city}, ${state}`,
                    dashboard_config: {
                        update_frequency: '30 minutes',
                        typical_daily_calls: '~48 calls/day',
                        timezone: 'America/New_York'
                    }
                };
                
                debugInfo.api_limits = {
                    free_tier: '1,000 calls/day, 60 calls/minute',
                    your_usage_check: 'Visit https://openweathermap.org/api to check current usage',
                    note: 'Dashboard uses ~48 calls/day (well within free limits)'
                };
                
                // Display debug information
                const debugContent = document.getElementById('debug-content');
                debugContent.textContent = JSON.stringify(debugInfo, null, 2);
                document.getElementById('debug-section').style.display = 'block';
                
                // Scroll to debug section
                document.getElementById('debug-section').scrollIntoView({ behavior: 'smooth' });
                
                showStatus('‚úÖ Weather debug information collected. See debug panel below.', 'success');
                
            } catch (error) {
                showStatus(`‚ùå Weather debug failed: ${error.message}`, 'error');
            } finally {
                debugBtn.disabled = false;
                debugBtn.innerHTML = originalHTML;
            }
        }
        
        function updateWeatherStatus(text, className) {
            const status = document.getElementById('weather-status');
            status.textContent = text;
            status.className = `section-status ${className}`;
        }
        
        // Calendar Functions
        function toggleCalDAVFields() {
            const provider = document.getElementById('caldav-provider').value;
            const fieldsDiv = document.getElementById('caldav-fields');
            const skipButton = document.getElementById('skip-calendar');
            const endpointGroup = document.getElementById('custom-endpoint-group');
            const passwordHelp = document.getElementById('password-help');
            
            if (!provider) {
                fieldsDiv.style.display = 'none';
                skipButton.style.display = 'block';
                return;
            }
            
            fieldsDiv.style.display = 'block';
            skipButton.style.display = 'none';
            endpointGroup.style.display = provider === 'generic' ? 'block' : 'none';
            
            // Update password help text with detailed instructions
            const helpTexts = {
                google: `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <strong>‚ö†Ô∏è Google Calendar requires an App Password:</strong>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Go to <a href="https://myaccount.google.com/security" target="_blank">Google Account Security</a></li>
                            <li>Enable <strong>2-Factor Authentication</strong> if not already enabled</li>
                            <li>Click <strong>"2-Step Verification"</strong> ‚Üí <strong>"App passwords"</strong></li>
                            <li>Select <strong>"Mail"</strong> and generate a 16-character password</li>
                            <li>Use that App Password (not your regular password) in the field above</li>
                        </ol>
                        <div style="font-size: 12px; color: #856404;">
                            üìù Works with Gmail and Google Workspace accounts
                        </div>
                    </div>
                `,
                apple: `
                    <div style="background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <strong>üçé Apple iCloud Setup:</strong>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Go to <a href="https://appleid.apple.com" target="_blank">Apple ID Settings</a></li>
                            <li>Sign in and go to <strong>"Security"</strong></li>
                            <li>Under <strong>"App-Specific Passwords"</strong>, click <strong>"Generate Password"</strong></li>
                            <li>Enter a label (e.g., "Family Dashboard") and generate</li>
                            <li>Use the generated password in the field above</li>
                        </ol>
                    </div>
                `,
                outlook: `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <strong>üìß Microsoft Outlook Setup:</strong>
                        <p>Most accounts can use your regular Microsoft password. If you have 2FA enabled:</p>
                        <ol style="margin: 10px 0; padding-left: 20px;">
                            <li>Go to <a href="https://account.microsoft.com/security" target="_blank">Microsoft Account Security</a></li>
                            <li>Click <strong>"Advanced security options"</strong></li>
                            <li>Under <strong>"App passwords"</strong>, create a new password</li>
                            <li>Use the app password instead of your regular password</li>
                        </ol>
                    </div>
                `,
                generic: `
                    <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-top: 10px;">
                        <strong>üîß Custom CalDAV Server:</strong>
                        <p>Enter the account password for your CalDAV server. Check with your server administrator if you're unsure about authentication requirements.</p>
                    </div>
                `
            };
            
            passwordHelp.innerHTML = helpTexts[provider] || '';
        }
        
        async function testCalDAVConnection() {
            const provider = document.getElementById('caldav-provider').value;
            const username = document.getElementById('caldav-username').value.trim();
            const password = document.getElementById('caldav-password').value.trim();
            const customEndpoint = document.getElementById('caldav-endpoint').value.trim();
            
            if (!provider || !username || !password) {
                showStatus('Please fill in all required fields.', 'error');
                return;
            }
            
            if (provider === 'generic' && !customEndpoint) {
                showStatus('Please enter the CalDAV server URL.', 'error');
                return;
            }
            
            const testBtn = document.querySelector('button[onclick="testCalDAVConnection()"]');
            const originalHTML = testBtn.innerHTML;
            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Testing...</div>';
            
            try {
                showStatus('Testing CalDAV connection...', 'info');
                
                if (!caldavClient) {
                    caldavClient = new CalDAVClient(window.dashboardConfig);
                }
                
                // Save config temporarily for testing
                caldavClient.saveConfig(provider, username, password, customEndpoint);
                
                const result = await caldavClient.testConnection();
                
                if (result.success) {
                    showStatus('‚úÖ CalDAV connection successful!', 'success');
                } else {
                    showStatus(`‚ùå Connection failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showStatus(`‚ùå Connection test failed: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = originalHTML;
            }
        }
        
        async function saveCalDAVConfig() {
            const provider = document.getElementById('caldav-provider').value;
            const username = document.getElementById('caldav-username').value.trim();
            const password = document.getElementById('caldav-password').value.trim();
            const customEndpoint = document.getElementById('caldav-endpoint').value.trim();
            
            if (!provider || !username || !password) {
                showStatus('Please fill in all required fields.', 'error');
                return;
            }
            
            const saveBtn = document.querySelector('button[onclick="saveCalDAVConfig()"]');
            const originalHTML = saveBtn.innerHTML;
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Saving...</div>';
            
            try {
                if (!caldavClient) {
                    caldavClient = new CalDAVClient(window.dashboardConfig);
                }
                
                const saved = caldavClient.saveConfig(provider, username, password, customEndpoint);
                
                if (saved) {
                    completedSteps.calendar = true;
                    updateProgressIndicator();
                    updateSectionStates();
                    
                    showStatus('‚úÖ Calendar configuration saved successfully!', 'success');
                    updateCalendarStatus('‚úÖ Configured', 'configured');
                } else {
                    showStatus('‚ùå Failed to save calendar configuration.', 'error');
                }
                
            } catch (error) {
                showStatus(`‚ùå Save error: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalHTML;
            }
        }
        
        function skipCalendar() {
            completedSteps.calendar = true;
            updateProgressIndicator();
            updateSectionStates();
            updateCalendarStatus('Skipped', 'missing');
            showStatus('Calendar setup skipped. You can configure it later from the dashboard.', 'info');
        }
        
        function clearCalDAVConfig() {
            if (confirm('Clear calendar configuration?')) {
                if (!caldavClient) {
                    caldavClient = new CalDAVClient(window.dashboardConfig);
                }
                
                caldavClient.clearConfig();
                
                // Clear form
                document.getElementById('caldav-provider').value = '';
                document.getElementById('caldav-username').value = '';
                document.getElementById('caldav-password').value = '';
                document.getElementById('caldav-endpoint').value = '';
                toggleCalDAVFields();
                
                completedSteps.calendar = false;
                updateProgressIndicator();
                updateSectionStates();
                updateCalendarStatus('Not Configured', 'missing');
                
                showStatus('Calendar configuration cleared.', 'info');
            }
        }
        
        function updateCalendarStatus(text, className) {
            const status = document.getElementById('calendar-status');
            status.textContent = text;
            status.className = `section-status ${className}`;
        }
        
        // Location Functions
        async function detectLocation() {
            const detectBtn = document.getElementById('detect-location-btn');
            const originalHTML = detectBtn.innerHTML;
            detectBtn.disabled = true;
            detectBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Detecting...</div>';
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation not supported by browser');
                }
                
                showStatus('Requesting location permission...', 'info');
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: false,
                        timeout: 15000,
                        maximumAge: 600000
                    });
                });
                
                const { latitude, longitude } = position.coords;
                showStatus('Location detected! Getting address...', 'info');
                
                // Reverse geocode
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`);
                const data = await response.json();
                
                const address = data.address || {};
                const city = address.city || address.town || address.village || 'Unknown City';
                const state = getStateAbbreviation(address.state || address.region || 'NY');
                
                // Update form
                document.getElementById('location-city').value = city;
                document.getElementById('location-state').value = state;
                
                await saveLocationConfig();
                
            } catch (error) {
                console.error('Location detection failed:', error);
                let message = 'Location detection failed. ';
                
                if (error.code === 1) {
                    message += 'Permission denied. Please enable location access and try again.';
                } else if (error.code === 2) {
                    message += 'Location unavailable. Please enter manually.';
                } else if (error.code === 3) {
                    message += 'Request timed out. Please try again or enter manually.';
                } else {
                    message += 'Please enter your location manually.';
                }
                
                showStatus(message, 'error');
            } finally {
                detectBtn.disabled = false;
                detectBtn.innerHTML = originalHTML;
            }
        }
        
        async function saveLocationConfig() {
            const city = document.getElementById('location-city').value.trim();
            const state = document.getElementById('location-state').value.trim().toUpperCase();
            
            if (!city || !state) {
                showStatus('Please enter both city and state.', 'error');
                return;
            }
            
            try {
                const config = window.dashboardConfig;
                config.set('location.city', city);
                config.set('location.state', state);
                
                completedSteps.location = true;
                updateProgressIndicator();
                updateSectionStates();
                
                // Update status display
                document.getElementById('location-status').textContent = `${city}, ${state}`;
                
                showStatus(`‚úÖ Location set to ${city}, ${state}`, 'success');
                
            } catch (error) {
                showStatus(`‚ùå Failed to save location: ${error.message}`, 'error');
            }
        }
        
        // Utility Functions
        function getStateAbbreviation(stateName) {
            const stateMap = {
                'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
                'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
                'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
                'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
                'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
                'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
                'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
                'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
            };
            
            return stateMap[stateName] || stateName;
        }
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status-message ${type}`;
            status.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    status.style.display = 'none';
                }, 5000);
            }
        }
        
        // New Management Functions
        async function testCurrentConnection() {
            if (!caldavClient) {
                showStatus('No calendar configuration found.', 'error');
                return;
            }
            
            const testBtn = document.querySelector('button[onclick="testCurrentConnection()"]');
            const originalHTML = testBtn.innerHTML;
            testBtn.disabled = true;
            testBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Testing...</div>';
            
            try {
                showStatus('Testing current CalDAV connection...', 'info');
                
                const result = await caldavClient.testConnection();
                
                if (result.success) {
                    showStatus('‚úÖ Current connection is working properly!', 'success');
                } else {
                    showStatus(`‚ùå Connection failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                showStatus(`‚ùå Connection test failed: ${error.message}`, 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.innerHTML = originalHTML;
            }
        }
        
        async function debugConnection() {
            if (!caldavClient) {
                showStatus('No calendar configuration found.', 'error');
                return;
            }
            
            const debugBtn = document.querySelector('button[onclick="debugConnection()"]');
            const originalHTML = debugBtn.innerHTML;
            debugBtn.disabled = true;
            debugBtn.innerHTML = '<div class="loading"><div class="spinner"></div> Debugging...</div>';
            
            try {
                showStatus('Gathering debug information...', 'info');
                
                // Create comprehensive debug information
                const config = window.dashboardConfig;
                const debugInfo = {
                    timestamp: new Date().toISOString(),
                    configuration: {
                        provider: config.get('caldav.provider'),
                        username: config.get('caldav.username'),
                        endpoint: config.get('caldav.endpoint'),
                        hasPassword: !!config.get('caldav.password')
                    },
                    browser: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform,
                        cookiesEnabled: navigator.cookieEnabled
                    }
                };
                
                // Test connection and get detailed results
                try {
                    const testResult = await caldavClient.testConnection();
                    debugInfo.connectionTest = testResult;
                } catch (error) {
                    debugInfo.connectionTest = { error: error.message, stack: error.stack };
                }
                
                // Try to get calendar events for debugging
                try {
                    const events = await caldavClient.getCalendarEvents('today');
                    debugInfo.eventTest = {
                        success: true,
                        eventCount: events.length,
                        sampleEvent: events[0] || null
                    };
                } catch (error) {
                    debugInfo.eventTest = { error: error.message };
                }
                
                // Display debug information
                const debugContent = document.getElementById('debug-content');
                debugContent.textContent = JSON.stringify(debugInfo, null, 2);
                document.getElementById('debug-section').style.display = 'block';
                
                showStatus('‚úÖ Debug information collected. See debug panel below.', 'success');
                
            } catch (error) {
                showStatus(`‚ùå Debug failed: ${error.message}`, 'error');
            } finally {
                debugBtn.disabled = false;
                debugBtn.innerHTML = originalHTML;
            }
        }
        
        function editCurrentConfig() {
            try {
                // Load from CalDAV client's localStorage (not dashboardConfig)
                const saved = localStorage.getItem('dashboard-caldav-config');
                if (!saved) {
                    showStatus('No saved configuration found.', 'error');
                    return;
                }
                
                const config = JSON.parse(saved);
                const provider = config.provider;
                const username = config.username;
                const endpoint = config.customEndpoint;
                
                // Populate form with current values
                document.getElementById('caldav-provider').value = provider || '';
                document.getElementById('caldav-username').value = username || '';
                document.getElementById('caldav-endpoint').value = endpoint || '';
                // Don't populate password for security - user will need to re-enter
                
                // Show the form
                toggleCalDAVFields();
                
                // Scroll to form
                document.getElementById('caldav-fields').scrollIntoView({ behavior: 'smooth' });
                
                if (provider === 'google') {
                    showStatus('üìù Configuration loaded. You\'ll need to re-enter your Google App Password (see instructions below).', 'info');
                } else {
                    showStatus('Configuration loaded for editing. Please re-enter your password and save.', 'info');
                }
                
                // Focus on password field since that needs to be re-entered
                setTimeout(() => {
                    document.getElementById('caldav-password').focus();
                }, 500);
                
            } catch (error) {
                showStatus(`Error loading configuration: ${error.message}`, 'error');
            }
        }
        
        function clearCurrentConfig() {
            if (confirm('This will remove your calendar configuration. Are you sure?')) {
                if (!caldavClient) {
                    caldavClient = new CalDAVClient(window.dashboardConfig);
                }
                
                caldavClient.clearConfig();
                
                // Clear form
                document.getElementById('caldav-provider').value = '';
                document.getElementById('caldav-username').value = '';
                document.getElementById('caldav-password').value = '';
                document.getElementById('caldav-endpoint').value = '';
                toggleCalDAVFields();
                
                // Update state
                completedSteps.calendar = false;
                updateProgressIndicator();
                updateSectionStates();
                updateCalendarStatus('Not Configured', 'missing');
                hideCurrentConfig();
                
                showStatus('Calendar configuration removed.', 'info');
            }
        }
        
        // Debug Panel Functions
        function hideDebugInfo() {
            document.getElementById('debug-section').style.display = 'none';
        }
        
        async function copyDebugInfo() {
            const debugContent = document.getElementById('debug-content').textContent;
            try {
                await navigator.clipboard.writeText(debugContent);
                showStatus('‚úÖ Debug information copied to clipboard!', 'success');
            } catch (error) {
                showStatus('‚ùå Failed to copy to clipboard. Use manual selection.', 'error');
            }
        }
        
        function exportDebugInfo() {
            const debugContent = document.getElementById('debug-content').textContent;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const filename = `caldav-debug-${timestamp}.json`;
            
            const blob = new Blob([debugContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus(`‚úÖ Debug information exported as ${filename}`, 'success');
        }
        
        function goToDashboard() {
            const config = window.dashboardConfig;
            if (config.get('openweather_api_key')) {
                window.location.href = 'dashboard.html?t=' + Date.now();
            } else {
                showStatus('Please configure weather API first.', 'error');
            }
        }
    </script>
</body>
</html>