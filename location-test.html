<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Detection Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #0d0; }
        button { padding: 10px 20px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Location Detection Test</h1>
    <button onclick="testLocationDetection()">Test Automatic Location Detection</button>
    <div id="results"></div>

    <script>
        async function testLocationDetection() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result">Testing location detection...</div>';
            
            try {
                if (!navigator.geolocation) {
                    throw new Error('Geolocation is not supported by this browser');
                }
                
                resultsDiv.innerHTML += '<div class="result">Requesting location permission...</div>';
                
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000 // 5 minutes
                    });
                });
                
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                
                resultsDiv.innerHTML += `<div class="result success">‚úÖ Location detected: ${lat.toFixed(6)}, ${lon.toFixed(6)}</div>`;
                
                // Test reverse geocoding
                resultsDiv.innerHTML += '<div class="result">Getting location details...</div>';
                
                const locationData = await reverseGeocode(lat, lon);
                
                resultsDiv.innerHTML += `<div class="result success">‚úÖ Location details: ${locationData.city}, ${locationData.state}</div>`;
                
                resultsDiv.innerHTML += '<div class="result success">üéâ All tests passed! Location detection is working.</div>';
                
            } catch (error) {
                let errorMessage = '‚ùå Location detection failed: ';
                
                if (error.code === 1) {
                    errorMessage += 'Permission denied. Please allow location access.';
                } else if (error.code === 2) {
                    errorMessage += 'Location unavailable. Please try again.';
                } else if (error.code === 3) {
                    errorMessage += 'Request timeout. Please try again.';
                } else {
                    errorMessage += error.message;
                }
                
                resultsDiv.innerHTML += `<div class="result error">${errorMessage}</div>`;
            }
        }
        
        async function reverseGeocode(lat, lon) {
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('Reverse geocoding failed');
                }
                
                const data = await response.json();
                console.log('Reverse geocoding result:', data);
                
                const address = data.address || {};
                
                // Extract city and state from various possible fields
                const city = address.city || address.town || address.village || address.hamlet || 
                           address.suburb || address.neighbourhood || 'Current Location';
                           
                const state = address.state || address.region || address.province || 
                            address.county || 'Auto-Detected';
                
                return {
                    city: city,
                    state: getStateAbbreviation(state)
                };
            } catch (error) {
                console.warn('Reverse geocoding failed, using fallback:', error);
                return {
                    city: 'Current Location',
                    state: 'Auto-Detected'
                };
            }
        }
        
        function getStateAbbreviation(stateName) {
            const stateMap = {
                'Alabama': 'AL', 'Alaska': 'AK', 'Arizona': 'AZ', 'Arkansas': 'AR', 'California': 'CA',
                'Colorado': 'CO', 'Connecticut': 'CT', 'Delaware': 'DE', 'Florida': 'FL', 'Georgia': 'GA',
                'Hawaii': 'HI', 'Idaho': 'ID', 'Illinois': 'IL', 'Indiana': 'IN', 'Iowa': 'IA',
                'Kansas': 'KS', 'Kentucky': 'KY', 'Louisiana': 'LA', 'Maine': 'ME', 'Maryland': 'MD',
                'Massachusetts': 'MA', 'Michigan': 'MI', 'Minnesota': 'MN', 'Mississippi': 'MS', 'Missouri': 'MO',
                'Montana': 'MT', 'Nebraska': 'NE', 'Nevada': 'NV', 'New Hampshire': 'NH', 'New Jersey': 'NJ',
                'New Mexico': 'NM', 'New York': 'NY', 'North Carolina': 'NC', 'North Dakota': 'ND', 'Ohio': 'OH',
                'Oklahoma': 'OK', 'Oregon': 'OR', 'Pennsylvania': 'PA', 'Rhode Island': 'RI', 'South Carolina': 'SC',
                'South Dakota': 'SD', 'Tennessee': 'TN', 'Texas': 'TX', 'Utah': 'UT', 'Vermont': 'VT',
                'Virginia': 'VA', 'Washington': 'WA', 'West Virginia': 'WV', 'Wisconsin': 'WI', 'Wyoming': 'WY'
            };
            
            return stateMap[stateName] || stateName;
        }
    </script>
</body>
</html>