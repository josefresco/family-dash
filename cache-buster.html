<!DOCTYPE html>
<html>
<head>
    <title>üßπ Complete Cache Buster Tool</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 20px; 
            line-height: 1.6; 
            background: #f8f9fa;
        }
        .container { max-width: 800px; margin: 0 auto; }
        .section { 
            background: white; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        .button { 
            background: #007bff; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            margin: 5px; 
            font-size: 16px;
            transition: all 0.2s ease;
        }
        .button:hover { background: #0056b3; transform: translateY(-1px); }
        .button.danger { background: #dc3545; }
        .button.danger:hover { background: #c82333; }
        .button.success { background: #28a745; }
        .button.success:hover { background: #218838; }
        .button.warning { background: #ffc107; color: #212529; }
        .button.warning:hover { background: #e0a800; }
        .results { 
            background: #e9ecef; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 15px 0; 
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .step { margin: 10px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 3px solid #6c757d; }
        .step.active { border-left-color: #007bff; background: #e3f2fd; }
        .step.complete { border-left-color: #28a745; background: #e8f5e8; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 30px; }
        h3 { color: #495057; margin-bottom: 15px; }
        .timestamp { font-size: 12px; color: #6c757d; }
        .url-info { background: #e3f2fd; padding: 10px; border-radius: 6px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Complete Cache Buster Tool</h1>
        <p class="timestamp">Current time: <span id="currentTime"></span></p>
        
        <div class="section">
            <h3>üìç Current Location</h3>
            <div class="url-info">
                <strong>Current URL:</strong> <span id="currentUrl"></span><br>
                <strong>Base Directory:</strong> <span id="baseDir"></span><br>
                <strong>User Agent:</strong> <span id="userAgent"></span>
            </div>
        </div>

        <div class="section warning">
            <h3>‚ö†Ô∏è iPad-Specific Cache Issues</h3>
            <p>iPads have multiple cache layers that can persist even after clearing browser data:</p>
            <ul>
                <li><strong>Service Worker Cache</strong> - From your sw.js file</li>
                <li><strong>Application Cache</strong> - PWA manifest caching</li>
                <li><strong>HTTP Cache</strong> - Browser HTTP responses</li>
                <li><strong>iOS Web Clip Cache</strong> - If added to home screen</li>
                <li><strong>DNS Cache</strong> - Cached domain lookups</li>
            </ul>
        </div>

        <div class="section">
            <h3>üöÄ Automated Cache Clearing</h3>
            <div class="grid">
                <button class="button warning" onclick="clearBrowserStorage()">Clear Browser Storage</button>
                <button class="button warning" onclick="clearServiceWorkers()">Clear Service Workers</button>
                <button class="button warning" onclick="clearApplicationCaches()">Clear App Caches</button>
                <button class="button danger" onclick="clearAll()">Clear Everything</button>
            </div>
            <div id="clearResults" class="results" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>üîÑ Server-Side Cache Busting</h3>
            <div class="grid">
                <button class="button" onclick="clearServerSessions()">Clear PHP Sessions</button>
                <button class="button" onclick="clearTokenFiles()">Clear Token Files</button>
                <button class="button" onclick="testWithCacheBuster()">Test with Cache Buster</button>
                <button class="button success" onclick="forceReload()">Force Hard Reload</button>
            </div>
            <div id="serverResults" class="results" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>üì± iPad-Specific Instructions</h3>
            <div class="step" id="step1">
                <strong>Step 1:</strong> Close Safari completely (swipe up and close all tabs)
            </div>
            <div class="step" id="step2">
                <strong>Step 2:</strong> Go to Settings ‚Üí Safari ‚Üí Clear History and Website Data
            </div>
            <div class="step" id="step3">
                <strong>Step 3:</strong> If added to home screen, delete the web app icon
            </div>
            <div class="step" id="step4">
                <strong>Step 4:</strong> Restart iPad (hold power + home/volume down)
            </div>
            <div class="step" id="step5">
                <strong>Step 5:</strong> Use private browsing mode for testing
            </div>
        </div>

        <div class="section">
            <h3>üîó Direct Cache-Busted Links</h3>
            <div class="grid">
                <a href="index.php?v=1733428800&cache=bust" class="button" target="_blank">Dashboard (Cache Bust)</a>
                <a href="auth.php?action=status&v=1733428800" class="button" target="_blank">Auth Status (Cache Bust)</a>
                <a href="api.php?endpoint=calendar&v=1733428800" class="button" target="_blank">Calendar API (Cache Bust)</a>
                <a href="clear-sessions.php?v=1733428800" class="button danger" target="_blank">Clear Sessions (Cache Bust)</a>
            </div>
        </div>

        <div class="section">
            <h3>üß™ Test Current State</h3>
            <div class="grid">
                <button class="button" onclick="testAuthStatus()">Test Auth</button>
                <button class="button" onclick="testCalendarAPI()">Test Calendar</button>
                <button class="button" onclick="checkServiceWorker()">Check Service Worker</button>
                <button class="button" onclick="checkManifest()">Check Manifest</button>
            </div>
            <div id="testResults" class="results" style="display: none;"></div>
        </div>

        <div class="section success" style="display: none;" id="successMessage">
            <h3>‚úÖ Cache Clearing Complete!</h3>
            <p>All caches have been cleared. You should now see the latest version of your application.</p>
            <button class="button success" onclick="window.location.reload(true)">Reload Page</button>
        </div>
    </div>

    <script>
        // Update current time and URL info
        function updateInfo() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString();
            document.getElementById('currentUrl').textContent = window.location.href;
            document.getElementById('baseDir').textContent = window.location.pathname.split('/').slice(0, -1).join('/') + '/';
            document.getElementById('userAgent').textContent = navigator.userAgent;
        }

        function log(message, elementId = 'clearResults') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
            console.log(message);
        }

        async function clearBrowserStorage() {
            log('üóëÔ∏è Clearing browser storage...');
            
            try {
                // Clear localStorage
                if (typeof(Storage) !== "undefined") {
                    localStorage.clear();
                    log('‚úÖ localStorage cleared');
                    sessionStorage.clear();
                    log('‚úÖ sessionStorage cleared');
                }

                // Clear IndexedDB
                if (window.indexedDB) {
                    const databases = await indexedDB.databases();
                    for (const db of databases) {
                        indexedDB.deleteDatabase(db.name);
                        log('‚úÖ IndexedDB cleared: ' + db.name);
                    }
                }

                // Clear WebSQL (deprecated but might exist)
                if (window.openDatabase) {
                    try {
                        const db = window.openDatabase("", "", "", "");
                        log('‚úÖ WebSQL cleared');
                    } catch (e) {
                        log('‚ÑπÔ∏è No WebSQL to clear');
                    }
                }

                log('‚úÖ Browser storage clearing complete');
            } catch (error) {
                log('‚ùå Error clearing browser storage: ' + error.message);
            }
        }

        async function clearServiceWorkers() {
            log('üîß Clearing service workers...');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    for (const registration of registrations) {
                        await registration.unregister();
                        log('‚úÖ Service worker unregistered: ' + registration.scope);
                    }
                    
                    if (registrations.length === 0) {
                        log('‚ÑπÔ∏è No service workers found');
                    }
                } catch (error) {
                    log('‚ùå Error clearing service workers: ' + error.message);
                }
            } else {
                log('‚ÑπÔ∏è Service workers not supported');
            }
        }

        async function clearApplicationCaches() {
            log('üì± Clearing application caches...');
            
            // Clear Cache API
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    for (const cacheName of cacheNames) {
                        await caches.delete(cacheName);
                        log('‚úÖ Cache deleted: ' + cacheName);
                    }
                    
                    if (cacheNames.length === 0) {
                        log('‚ÑπÔ∏è No caches found');
                    }
                } catch (error) {
                    log('‚ùå Error clearing caches: ' + error.message);
                }
            }

            // Force reload with cache bypass
            log('üîÑ Forcing cache bypass reload...');
        }

        async function clearAll() {
            log('üßπ Starting complete cache clear...');
            
            await clearBrowserStorage();
            await clearServiceWorkers();
            await clearApplicationCaches();
            
            log('‚úÖ All client-side caches cleared!');
            log('üìã Next steps:');
            log('1. Close all browser tabs');
            log('2. Clear browser history/data in settings');
            log('3. Restart browser or device');
            log('4. Visit site in private/incognito mode');
            
            document.getElementById('successMessage').style.display = 'block';
        }

        async function clearServerSessions() {
            log('üñ•Ô∏è Clearing server sessions...', 'serverResults');
            
            try {
                const response = await fetch('clear-sessions.php?v=' + Date.now());
                const text = await response.text();
                log('‚úÖ Server session clear response received', 'serverResults');
                log('Response length: ' + text.length + ' characters', 'serverResults');
            } catch (error) {
                log('‚ùå Error clearing server sessions: ' + error.message, 'serverResults');
            }
        }

        async function clearTokenFiles() {
            log('üîë Clearing token files...', 'serverResults');
            
            try {
                const response = await fetch('auth.php?action=logout&v=' + Date.now());
                const data = await response.json();
                log('‚úÖ Token clear response: ' + JSON.stringify(data), 'serverResults');
            } catch (error) {
                log('‚ùå Error clearing tokens: ' + error.message, 'serverResults');
            }
        }

        function testWithCacheBuster() {
            const cacheBuster = Date.now();
            const url = 'index.php?v=' + cacheBuster + '&cache=bust&test=true';
            log('üîó Opening cache-busted URL: ' + url, 'serverResults');
            window.open(url, '_blank');
        }

        function forceReload() {
            log('üîÑ Forcing hard reload...', 'serverResults');
            
            // Multiple methods to force reload
            if (window.location.reload) {
                window.location.reload(true); // Force reload from server
            }
            
            // Fallback: redirect with cache buster
            setTimeout(() => {
                window.location.href = window.location.href + '?v=' + Date.now();
            }, 100);
        }

        async function testAuthStatus() {
            log('üîç Testing auth status...', 'testResults');
            
            try {
                const response = await fetch('auth.php?action=status&v=' + Date.now());
                const data = await response.json();
                log('üìä Auth Status: ' + JSON.stringify(data, null, 2), 'testResults');
            } catch (error) {
                log('‚ùå Auth test error: ' + error.message, 'testResults');
            }
        }

        async function testCalendarAPI() {
            log('üìÖ Testing calendar API...', 'testResults');
            
            try {
                const response = await fetch('api.php?endpoint=calendar&v=' + Date.now());
                const data = await response.json();
                log('üìä Calendar API: ' + JSON.stringify(data, null, 2), 'testResults');
            } catch (error) {
                log('‚ùå Calendar test error: ' + error.message, 'testResults');
            }
        }

        async function checkServiceWorker() {
            log('üîß Checking service worker status...', 'testResults');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    log('üîç Found ' + registrations.length + ' service worker(s)', 'testResults');
                    
                    for (const reg of registrations) {
                        log('üìç SW Scope: ' + reg.scope, 'testResults');
                        log('üìç SW State: ' + (reg.active ? reg.active.state : 'inactive'), 'testResults');
                    }
                } catch (error) {
                    log('‚ùå Service worker check error: ' + error.message, 'testResults');
                }
            } else {
                log('‚ÑπÔ∏è Service workers not supported', 'testResults');
            }
        }

        async function checkManifest() {
            log('üì± Checking PWA manifest...', 'testResults');
            
            try {
                const response = await fetch('manifest.json?v=' + Date.now());
                const manifest = await response.json();
                log('üìä Manifest loaded: ' + manifest.name, 'testResults');
                log('üìä Start URL: ' + manifest.start_url, 'testResults');
            } catch (error) {
                log('‚ùå Manifest check error: ' + error.message, 'testResults');
            }
        }

        // Auto-update info on load
        updateInfo();
        setInterval(updateInfo, 1000);

        // Add cache-busting parameters to all relative links
        document.addEventListener('DOMContentLoaded', function() {
            const cacheBuster = Date.now();
            const links = document.querySelectorAll('a[href^="/"]:not([href*="v="]), a[href^="./"]:not([href*="v="])');
            
            links.forEach(link => {
                const url = new URL(link.href);
                url.searchParams.set('v', cacheBuster);
                link.href = url.toString();
            });
        });

        // Detect iPad and show specific warnings
        if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
            log('üì± iPad/iOS detected - Cache clearing may require additional steps');
            
            // Highlight iPad-specific steps
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                step.addEventListener('click', function() {
                    this.classList.add('complete');
                    if (index < steps.length - 1) {
                        steps[index + 1].classList.add('active');
                    }
                });
            });
            
            // Auto-activate first step
            if (steps.length > 0) {
                steps[0].classList.add('active');
            }
        }
    </script>
</body>
</html>