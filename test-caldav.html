<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalDAV Connection Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .form-group { margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input { width: 100%; padding: 8px; box-sizing: border-box; }
        button { background: #007cba; color: white; padding: 10px 20px; border: none; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .results { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .info { background: #e3f2fd; border-left: 4px solid #2196f3; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        .test-step { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>CalDAV Google Calendar Connection Test</h1>
    
    <div class="form-group">
        <label for="email">Google Email:</label>
        <input type="email" id="email" placeholder="your.email@gmail.com">
    </div>
    
    <div class="form-group">
        <label for="appPassword">Google App Password:</label>
        <input type="password" id="appPassword" placeholder="16-character app password">
        <small>Generate at: <a href="https://myaccount.google.com/apppasswords" target="_blank">Google App Passwords</a></small>
    </div>
    
    <div class="form-group">
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="testNetlifyFunction()">Test Netlify Function Only</button>
        <button onclick="testDirectCalDAV()">Test Direct CalDAV</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `results ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        async function testNetlifyFunction() {
            const email = document.getElementById('email').value;
            const appPassword = document.getElementById('appPassword').value;
            
            if (!email || !appPassword) {
                log('Please enter both email and app password', 'error');
                return;
            }
            
            log('üß™ Testing Netlify Function...', 'info');
            
            try {
                const response = await fetch('/api/calendar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'google',
                        username: email,
                        password: appPassword,
                        dateParam: 'today'
                    })
                });
                
                log(`Response Status: ${response.status} ${response.statusText}`, 
                    response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                let responseData;
                
                try {
                    responseData = JSON.parse(responseText);
                    log(`Response Data: <pre>${JSON.stringify(responseData, null, 2)}</pre>`, 
                        response.ok ? 'success' : 'error');
                } catch {
                    log(`Raw Response: <pre>${responseText}</pre>`, 'error');
                }
                
                if (response.ok) {
                    log('‚úÖ Netlify function working correctly!', 'success');
                } else {
                    log('‚ùå Netlify function failed', 'error');
                }
                
            } catch (error) {
                log(`Network Error: ${error.message}`, 'error');
            }
        }

        async function testDirectCalDAV() {
            const email = document.getElementById('email').value;
            const appPassword = document.getElementById('appPassword').value;
            
            if (!email || !appPassword) {
                log('Please enter both email and app password', 'error');
                return;
            }
            
            log('üîç Testing Direct CalDAV Connection...', 'info');
            
            const caldavUrl = `https://apidata.googleusercontent.com/caldav/v2/${email}/events/`;
            log(`CalDAV URL: ${caldavUrl}`, 'info');
            
            const authHeader = 'Basic ' + btoa(`${email}:${appPassword}`);
            log(`Auth Header: Basic ${btoa(`${email}:${appPassword}`).substring(0, 20)}...`, 'info');
            
            // Test 1: OPTIONS request (preflight)
            log('Test 1: OPTIONS request...', 'info');
            try {
                const optionsResponse = await fetch(caldavUrl, {
                    method: 'OPTIONS',
                    headers: {
                        'Authorization': authHeader,
                    }
                });
                log(`OPTIONS Response: ${optionsResponse.status} ${optionsResponse.statusText}`, 
                    optionsResponse.ok ? 'success' : 'error');
            } catch (error) {
                log(`OPTIONS Error: ${error.message}`, 'error');
            }
            
            // Test 2: PROPFIND request (basic calendar discovery)
            log('Test 2: PROPFIND request...', 'info');
            try {
                const propfindResponse = await fetch(caldavUrl, {
                    method: 'PROPFIND',
                    headers: {
                        'Authorization': authHeader,
                        'Content-Type': 'application/xml; charset=utf-8',
                        'Depth': '1'
                    },
                    body: `<?xml version="1.0" encoding="utf-8" ?>
                           <D:propfind xmlns:D="DAV:">
                             <D:prop>
                               <D:displayname />
                               <D:resourcetype />
                             </D:prop>
                           </D:propfind>`
                });
                
                log(`PROPFIND Response: ${propfindResponse.status} ${propfindResponse.statusText}`, 
                    propfindResponse.ok ? 'success' : 'error');
                
                if (!propfindResponse.ok) {
                    const errorText = await propfindResponse.text();
                    log(`PROPFIND Error Details: <pre>${errorText}</pre>`, 'error');
                }
                
            } catch (error) {
                log(`PROPFIND Error: ${error.message}`, 'error');
            }
            
            // Test 3: Try alternative Google CalDAV endpoints
            log('Test 3: Testing alternative endpoints...', 'info');
            
            const alternativeEndpoints = [
                `https://apidata.googleusercontent.com/caldav/v2/${email}/user/`,
                `https://apidata.googleusercontent.com/caldav/v2/${email}/`,
                `https://calendar.google.com/calendar/dav/${email}/events/`,
                `https://www.google.com/calendar/dav/${email}/events/`
            ];
            
            for (const endpoint of alternativeEndpoints) {
                try {
                    log(`Trying endpoint: ${endpoint}`, 'info');
                    const testResponse = await fetch(endpoint, {
                        method: 'PROPFIND',
                        headers: {
                            'Authorization': authHeader,
                            'Content-Type': 'application/xml; charset=utf-8',
                            'Depth': '1'
                        },
                        body: `<?xml version="1.0" encoding="utf-8" ?><D:propfind xmlns:D="DAV:"><D:prop><D:displayname /></D:prop></D:propfind>`
                    });
                    
                    log(`${endpoint}: ${testResponse.status} ${testResponse.statusText}`, 
                        testResponse.ok ? 'success' : 'error');
                        
                    if (testResponse.ok) {
                        const responseText = await testResponse.text();
                        log(`‚úÖ Working endpoint found! Response: <pre>${responseText.substring(0, 500)}...</pre>`, 'success');
                        break;
                    }
                } catch (error) {
                    log(`${endpoint}: ${error.message}`, 'error');
                }
            }
        }

        async function testCredentials() {
            const email = document.getElementById('email').value;
            const appPassword = document.getElementById('appPassword').value;
            
            log('üîê Testing Credentials Format...', 'info');
            
            // Validate email format
            if (!email.includes('@gmail.com') && !email.includes('@googlemail.com')) {
                log('‚ö†Ô∏è Email should be a Gmail address (@gmail.com)', 'error');
            } else {
                log('‚úÖ Email format looks correct', 'success');
            }
            
            // Validate app password format
            if (!appPassword) {
                log('‚ùå App password is required', 'error');
            } else if (appPassword.length !== 16) {
                log(`‚ö†Ô∏è App password should be 16 characters (current: ${appPassword.length})`, 'error');
            } else if (!/^[a-zA-Z]{16}$/.test(appPassword)) {
                log('‚ö†Ô∏è App password should only contain letters', 'error');
            } else {
                log('‚úÖ App password format looks correct', 'success');
            }
            
            // Check if using regular password instead of app password
            if (appPassword.length < 10 || /\d/.test(appPassword) || /[!@#$%^&*(),.?":{}|<>]/.test(appPassword)) {
                log('‚ö†Ô∏è This looks like a regular password. Make sure you\'re using a Google App Password', 'error');
            }
        }

        async function runAllTests() {
            clearResults();
            log('üöÄ Starting comprehensive CalDAV test...', 'info');
            
            await testCredentials();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testNetlifyFunction();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDirectCalDAV();
            
            log('üèÅ All tests completed!', 'info');
        }
    </script>
</body>
</html>